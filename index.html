<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Life Balance Planner (168-hour week)</title>

  <!-- Chart.js + DataLabels plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <style>
    :root{
      --bg:#f7f7f7;
      --card:#fff;
      --text:#111;
      --muted:#666;
      --danger:#b00020;
      --ok:#147a3a;

      /* Brand */
      --brand:#28456A;
      --brand-muted:#5E6F86;
      --brand-header-bg:#28456A;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: Calibri, "Segoe UI", Arial, system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 22px;
    }

    /* ===== Brand Header ===== */
    .brand-header{
      display:flex;
      align-items:center;
      justify-content: space-between;
      background: var(--brand-header-bg);
      max-width: 1240px;
      margin: 6px auto 18px auto;
      height: 104px;
      padding: 0 18px;
      overflow: hidden;
    }

    .brand-left{
      display:flex;
      align-items:center;
      min-width:0;
    }

    .brand-logo-img{
      height: 82px;
      width: auto;
      display:block;
      margin-left: 12px;
    }

    .brand-right{
      color:#fff;
      font-size: 18px;
      font-style: italic;
      font-weight: 600;
      letter-spacing: 0.3px;
      white-space: nowrap;
      margin-left: 18px;
      margin-right: 12px;
      opacity: 0.95;
    }

    @media (max-width: 900px){
      .brand-right{ display:none; }
      .brand-header{ height: 88px; }
      .brand-logo-img{ height: 62px; margin-left: 8px; }
    }

    /* ===== Layout ===== */
    .wrap{
      max-width: 1240px;
      margin:0 auto;
      display:grid;
      gap:16px;
      grid-template-columns: 1.05fr 0.95fr;
    }
    @media (max-width: 1100px){
      .wrap{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border-radius: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,.08);
      padding: 16px;
    }

    h1{
      font-size: 20px;
      margin: 0 0 10px;
      color: var(--brand);
    }

    .sub{
      color: var(--brand-muted);
      font-size: 13px;
      margin: 0 0 14px;
      line-height: 1.4;
    }

    table{ width:100%; border-collapse: collapse; }
    th, td{
      padding: 10px 8px;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }

    thead th{
      background: var(--brand);
      color: #fff;
      font-weight: 800;
      font-size: 15px;
      border-bottom: none;
      padding: 12px 10px;
    }

    th{ text-align:left; }
    td:nth-child(2), td:nth-child(3),
    th:nth-child(2), th:nth-child(3){ text-align:right; }

    input[type="number"]{
      width: 110px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 14px;
      text-align: right;
      font-family: inherit;
    }

    /* “Other” label inputs */
    .other-label{
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 14px;
      font-family: inherit;
    }

    .pct{ font-variant-numeric: tabular-nums; color:#222; }

    .totals{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .pill{
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 10px 12px;
      display:flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
    }
    .pill .k{ color: var(--brand-muted); font-size: 13px; }
    .pill .v{ font-weight: 800; font-variant-numeric: tabular-nums; }

    .status{ margin-top: 10px; font-size: 13px; }
    .status.ok{ color: var(--ok); }
    .status.bad{ color: var(--danger); }

    .btnrow{ display:flex; flex-wrap: wrap; gap:10px; margin-top: 12px; }

    button{
      border:none;
      border-radius: 12px;
      padding: 10px 14px;
      cursor:pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,.08);
      font-weight: 800;
      font-family: inherit;
      background: var(--brand);
      color:#fff;
    }
    button:disabled{ opacity:.5; cursor:not-allowed; }

    .chartBox{ height: 520px; }

    .legendNote{
      margin-top: 8px;
      color: var(--brand-muted);
      font-size: 12px;
      line-height: 1.4;
    }

    /* ===== PRINT: make the PDF look like a designed worksheet ===== */
    @media print {
      @page { margin: 12mm; }

      body {
        background: #fff !important;
        padding: 0 !important;
      }

      /* Remove “website” shadows */
      .card {
        box-shadow: none !important;
        border: 1px solid #e6e6e6 !important;
        border-radius: 10px !important;
        page-break-inside: avoid;
      }

      /* Print as a single column */
      .wrap {
        grid-template-columns: 1fr !important;
        gap: 10px !important;
        max-width: none !important;
      }

      /* Tighten header for print */
      .brand-header {
        max-width: none !important;
        margin: 0 0 10mm 0 !important;
        height: 70px !important;
        padding: 0 12px !important;
      }
      .brand-logo-img { height: 52px !important; margin-left: 0 !important; }
      .brand-right { font-size: 14px !important; }

      /* Hide buttons + web-only notes */
      .btnrow, .legendNote {
        display: none !important;
      }

      /* Document-like typography */
      h1 {
        font-size: 18pt !important;
        margin: 0 0 6pt 0 !important;
      }
      .sub {
        font-size: 11pt !important;
        margin: 0 0 10pt 0 !important;
      }

      /* Ensure the blue table header prints */
      thead th {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      /* Chart sizing for print */
      .chartBox {
        height: 140mm !important;
      }

      /* Force chart card onto its own page */
      .wrap > .card:nth-child(2) {
        break-before: page;
        page-break-before: always;
      }
    }
  </style>
</head>

<body>
  <!-- Branded Header -->
  <div class="brand-header">
    <div class="brand-left">
      <!-- Put rl-logo-white.png in the repo root next to index.html -->
      <img src="rl-logo-white.png" alt="Robertson Lowstuter" class="brand-logo-img" />
    </div>
    <div class="brand-right">“Create Uncommon Results!®”</div>
  </div>

  <div class="wrap">
    <!-- Planner -->
    <div class="card">
      <h1>Life Balance Planner (168-hour week)</h1>
      <p class="sub">
        Enter hours per week. Percentages + totals update automatically.
        Your entries auto-save in this browser on this device.
      </p>

      <table>
        <thead>
          <tr>
            <th>Category</th>
            <th>Hours / Week</th>
            <th>% of Week</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>

      <div class="totals">
        <div class="pill"><div class="k">Total Hours Used</div><div class="v" id="totalUsed">0</div></div>
        <div class="pill"><div class="k">Total Hours Remaining</div><div class="v" id="totalRemaining">168</div></div>
        <div class="pill"><div class="k">% Used</div><div class="v" id="pctUsed">0.0%</div></div>
        <div class="pill"><div class="k">% Remaining</div><div class="v" id="pctRemaining">100.0%</div></div>
      </div>

      <div class="status ok" id="status">Ready.</div>

      <div class="btnrow">
        <button id="downloadPngBtn">Download Chart (PNG)</button>
        <button id="printBtn">Print / Save as PDF</button>
        <button id="clearBtn">Clear All</button>
      </div>

      <div class="legendNote">
        The pie chart includes a <b>Remaining</b> slice so pie % matches “% of week.”
      </div>
    </div>

    <!-- Chart -->
    <div class="card">
      <h1>Life Balance Pie Chart</h1>
      <p class="sub">Percentages display inside slices. Legend on the right matches slice colors.</p>

      <div class="chartBox">
        <canvas id="chartCanvas"></canvas>
      </div>
    </div>
  </div>

<script>
(() => {
  const WEEK = 168;
  const LS_KEY = "life_balance_hours_brand_v5"; // includes other labels + hours

  const CATEGORIES = [
    { label: "Family",            key: "family",           color: "#CEA8F0", labelEditable: false },
    { label: "Friends",           key: "friends",          color: "#FFC2E8", labelEditable: false },
    { label: "Work",              key: "work",             color: "#D8B6A1", labelEditable: false },
    { label: "Sleep/Rest",        key: "sleep",            color: "#FFF3C5", labelEditable: false },
    { label: "Eating/Food Prep",  key: "eating",           color: "#D2F1C3", labelEditable: false },
    { label: "Health/Fitness",    key: "health",           color: "#C2DCFF", labelEditable: false },
    { label: "Self-Improvement",  key: "self_improvement", color: "#FF9999", labelEditable: false },
    { label: "Hobbies",           key: "hobbies",          color: "#C1FF72", labelEditable: false },
    { label: "Service/Charity",   key: "service",          color: "#FFDE59", labelEditable: false },
    { label: "Spirituality",      key: "spirituality",     color: "#FF914D", labelEditable: false },
    { label: "Self-Care",         key: "self_care",        color: "#74A45A", labelEditable: false },

    { label: "Other 1",           key: "other1",           color: "#6DB4FF", labelEditable: true },
    { label: "Other 2",           key: "other2",           color: "#997CAB", labelEditable: true }
  ];

  const rowsEl = document.getElementById("rows");
  const totalUsedEl = document.getElementById("totalUsed");
  const totalRemainingEl = document.getElementById("totalRemaining");
  const pctUsedEl = document.getElementById("pctUsed");
  const pctRemainingEl = document.getElementById("pctRemaining");
  const statusEl = document.getElementById("status");

  const downloadPngBtn = document.getElementById("downloadPngBtn");
  const printBtn = document.getElementById("printBtn");
  const clearBtn = document.getElementById("clearBtn");

  function clampNonNeg(n){
    if (!isFinite(n)) return 0;
    return n < 0 ? 0 : n;
  }
  function fmtPctOfWeek(hours){
    return ((hours / WEEK) * 100).toFixed(1) + "%";
  }
  function fmtNum(x){
    return (Math.round(x * 10) / 10).toString();
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return { hours: {}, labels: {} };
      const obj = JSON.parse(raw);
      if (!obj || typeof obj !== "object") return { hours: {}, labels: {} };
      return {
        hours: (obj.hours && typeof obj.hours === "object") ? obj.hours : {},
        labels: (obj.labels && typeof obj.labels === "object") ? obj.labels : {}
      };
    }catch{
      return { hours: {}, labels: {} };
    }
  }

  function saveState(state){
    try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch{}
  }

  let currentState = loadState();

  function getCustomLabel(key){
    const input = document.getElementById("label_" + key);
    const typed = input ? input.value.trim() : "";
    if (typed) return typed;

    const stored = currentState.labels[key];
    if (stored && ("" + stored).trim()) return ("" + stored).trim();

    const cat = CATEGORIES.find(c => c.key === key);
    return cat ? cat.label : key;
  }

  function buildTable(){
    rowsEl.innerHTML = "";

    for (const c of CATEGORIES){
      const tr = document.createElement("tr");

      const td1 = document.createElement("td");

      if (c.labelEditable){
        const lbl = document.createElement("input");
        lbl.type = "text";
        lbl.id = "label_" + c.key;
        lbl.className = "other-label";
        lbl.placeholder = c.label;

        const saved = currentState.labels[c.key];
        if (saved && ("" + saved).trim()) lbl.value = ("" + saved).trim();

        lbl.addEventListener("input", onAnyChange);
        lbl.addEventListener("blur", onAnyChange);

        td1.appendChild(lbl);
      } else {
        td1.textContent = c.label;
      }

      const td2 = document.createElement("td");
      const inp = document.createElement("input");
      inp.type = "number";
      inp.step = "1";
      inp.min = "0";
      inp.inputMode = "decimal";
      inp.id = "hours_" + c.key;

      const savedHours = currentState.hours[c.key];
      inp.value = (savedHours ?? "").toString();

      inp.addEventListener("input", onAnyChange);
      inp.addEventListener("blur", onAnyChange);
      td2.appendChild(inp);

      const td3 = document.createElement("td");
      td3.className = "pct";
      td3.id = "pct_" + c.key;
      td3.textContent = "0.0%";

      tr.appendChild(td1);
      tr.appendChild(td2);
      tr.appendChild(td3);
      rowsEl.appendChild(tr);
    }
  }

  function readStateFromUI(){
    const hours = {};
    const labels = {};

    for (const c of CATEGORIES){
      const hEl = document.getElementById("hours_" + c.key);
      const v = clampNonNeg(parseFloat(hEl.value));
      if (v > 0) hours[c.key] = v;

      if (c.labelEditable){
        const lEl = document.getElementById("label_" + c.key);
        const t = (lEl ? lEl.value.trim() : "");
        if (t) labels[c.key] = t;
      }
    }

    return { hours, labels };
  }

  let chart;

  function initChart(){
    const canvas = document.getElementById("chartCanvas");
    const ctx = canvas.getContext("2d");

    if (typeof ChartDataLabels !== "undefined") {
      Chart.register(ChartDataLabels);
    }

    chart = new Chart(ctx, {
      type: "pie",
      data: {
        labels: [],
        datasets: [{
          data: [],
          backgroundColor: [],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: "right",
            labels: {
              boxWidth: 14,
              padding: 12,
              font: { size: 12, weight: "600" },
              generateLabels: (chart) => {
                const data = chart.data;
                const ds = data.datasets[0];
                const values = ds.data || [];
                const total = values.reduce((a, b) => a + Number(b || 0), 0);

                return data.labels.map((label, i) => {
                  const v = Number(values[i] || 0);
                  const pct = total ? (v / total) * 100 : 0;

                  return {
                    text: `${label} — ${pct.toFixed(1)}%`,
                    fillStyle: Array.isArray(ds.backgroundColor) ? ds.backgroundColor[i] : ds.backgroundColor,
                    strokeStyle: "#fff",
                    lineWidth: 1,
                    hidden: chart.getDataVisibility(i) === false,
                    index: i
                  };
                });
              }
            }
          },

          datalabels: {
            formatter: (value) => {
              const pct = (Number(value || 0) / WEEK) * 100;
              if (pct < 4) return "";
              return pct.toFixed(1) + "%";
            },
            color: "#111",
            font: { weight: "800", size: 14 },
            textStrokeColor: "#fff",
            textStrokeWidth: 4,
            anchor: "center",
            align: "center",
            clamp: true
          },

          tooltip: {
            callbacks: {
              label: (context) => {
                const label = context.label || "";
                const v = Number(context.raw || 0);
                const pct = (v / WEEK) * 100;
                return `${label}: ${v.toFixed(1)} hrs (${pct.toFixed(1)}%)`;
              }
            }
          }
        }
      }
    });
  }

  function updateUI(){
    currentState = readStateFromUI();
    saveState(currentState);

    const used = Object.values(currentState.hours).reduce((a,b) => a + Number(b || 0), 0);
    const remaining = WEEK - used;

    totalUsedEl.textContent = fmtNum(used);
    totalRemainingEl.textContent = fmtNum(remaining);

    pctUsedEl.textContent = ((used / WEEK) * 100).toFixed(1) + "%";
    pctRemainingEl.textContent = ((remaining / WEEK) * 100).toFixed(1) + "%";

    for (const c of CATEGORIES){
      const v = Number(currentState.hours[c.key] || 0);
      document.getElementById("pct_" + c.key).textContent = fmtPctOfWeek(v);
    }

    if (used > WEEK){
      statusEl.className = "status bad";
      statusEl.textContent = `Total exceeds ${WEEK} hours by ${(used - WEEK).toFixed(1)}. Reduce inputs.`;
    } else {
      statusEl.className = "status ok";
      statusEl.textContent = `You have ${(WEEK - used).toFixed(1)} hours remaining.`;
    }

    if (used === 0){
      chart.data.labels = [];
      chart.data.datasets[0].data = [];
      chart.data.datasets[0].backgroundColor = [];
      chart.update();
      return;
    }

    const items = CATEGORIES
      .map(c => {
        const val = Number(currentState.hours[c.key] || 0);
        const label = c.labelEditable ? getCustomLabel(c.key) : c.label;
        return { label, value: val, color: c.color };
      })
      .filter(x => x.value > 0)
      .sort((a,b)=>b.value-a.value);

    if (remaining > 0){
      items.push({ label: "Remaining", value: remaining, color: "#E6E6E6" });
    }

    chart.data.labels = items.map(x => x.label);
    chart.data.datasets[0].data = items.map(x => x.value);
    chart.data.datasets[0].backgroundColor = items.map(x => x.color);
    chart.update();
  }

  let rafPending = false;
  function onAnyChange(){
    if (rafPending) return;
    rafPending = true;
    requestAnimationFrame(() => {
      rafPending = false;
      updateUI();
    });
  }

  downloadPngBtn.addEventListener("click", () => {
    const canvas = chart.canvas;
    const filename = "life-balance-chart.png";

    if (canvas.toBlob){
      canvas.toBlob((blob) => {
        if (!blob) return;
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }, "image/png");
    } else {
      window.open(canvas.toDataURL("image/png"), "_blank");
    }
  });

  /* Print helper: ensures chart is drawn before print */
  printBtn.addEventListener("click", () => {
    chart.update();
    setTimeout(() => window.print(), 80);
  });

  clearBtn.addEventListener("click", () => {
    if (!confirm("Clear all hours and labels?")) return;

    for (const c of CATEGORIES){
      const hEl = document.getElementById("hours_" + c.key);
      if (hEl) hEl.value = "";

      if (c.labelEditable){
        const lEl = document.getElementById("label_" + c.key);
        if (lEl) lEl.value = "";
      }
    }

    currentState = { hours: {}, labels: {} };
    saveState(currentState);
    updateUI();
  });

  // Boot
  buildTable();
  initChart();
  updateUI();
})();
</script>
</body>
</html>
